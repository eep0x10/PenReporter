{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stat Cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-xl-3">
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(88,166,255,.15);color:#58a6ff">
        <i class="bi bi-file-earmark-text-fill"></i>
      </div>
      <div class="stat-body">
        <div class="stat-value">{{ total_reports }}</div>
        <div class="stat-label">Total de Relatórios</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-xl-3">
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(63,185,80,.15);color:#3fb950">
        <i class="bi bi-buildings-fill"></i>
      </div>
      <div class="stat-body">
        <div class="stat-value">{{ total_clients }}</div>
        <div class="stat-label">Clientes</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-xl-3">
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(248,81,73,.15);color:#f85149">
        <i class="bi bi-bug-fill"></i>
      </div>
      <div class="stat-body">
        <div class="stat-value">{{ open_vulns }}</div>
        <div class="stat-label">Vulns. Abertas</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-xl-3">
    <div class="stat-card border-critical">
      <div class="stat-icon" style="background:rgba(248,81,73,.2);color:#f85149">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </div>
      <div class="stat-body">
        <div class="stat-value text-critical">{{ critical_vulns }}</div>
        <div class="stat-label">Críticas Abertas</div>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row -->
<div class="row g-3 mb-4">
  <div class="col-md-5">
    <div class="card-dark h-100">
      <div class="card-dark-header">
        <i class="bi bi-pie-chart-fill me-2 text-accent"></i>Vulnerabilidades por Severidade
      </div>
      <div class="card-dark-body d-flex align-items-center justify-content-center" style="min-height:260px">
        {% if sev_labels %}
          <canvas id="sevChart" style="max-height:240px"></canvas>
        {% else %}
          <div class="empty-state">
            <i class="bi bi-bug"></i>
            <p>Nenhuma vulnerabilidade ainda</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-7">
    <div class="card-dark h-100">
      <div class="card-dark-header">
        <i class="bi bi-bar-chart-fill me-2 text-accent"></i>Relatórios por Status
      </div>
      <div class="card-dark-body d-flex align-items-center justify-content-center" style="min-height:260px">
        {% if status_labels %}
          <canvas id="statusChart" style="max-height:240px"></canvas>
        {% else %}
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <p>Nenhum relatório ainda</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Tables Row -->
<div class="row g-3">
  <div class="col-lg-7">
    <div class="card-dark">
      <div class="card-dark-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history me-2 text-accent"></i>Relatórios Recentes</span>
        <a href="{{ url_for('reports.index') }}" class="btn btn-xs btn-outline-accent">Ver todos</a>
      </div>
      <div class="card-dark-body p-0">
        {% if recent_reports %}
        <div class="table-responsive">
          <table class="table table-dark-custom mb-0">
            <thead>
              <tr>
                <th>Título</th>
                <th>Cliente</th>
                <th>Status</th>
                <th>Risco</th>
              </tr>
            </thead>
            <tbody>
              {% for r in recent_reports %}
              <tr>
                <td>
                  <a href="{{ url_for('reports.view', report_id=r.id) }}" class="text-white fw-medium hover-accent">
                    {{ r.title|truncate(40) }}
                  </a>
                </td>
                <td class="text-muted small">{{ r.client.name }}</td>
                <td><span class="badge-status badge-{{ r.status|lower|replace(' ','-') }}">{{ r.status }}</span></td>
                <td>
                  {% if r.overall_risk %}
                    <span class="badge-sev badge-{{ r.overall_risk|lower }}">{{ r.overall_risk }}</span>
                  {% else %}
                    <span class="text-muted small">—</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="empty-state py-4">
            <i class="bi bi-file-earmark-text"></i>
            <p>Nenhum relatório criado ainda</p>
            <a href="{{ url_for('reports.create') }}" class="btn btn-sm btn-accent">Criar primeiro relatório</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card-dark">
      <div class="card-dark-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-exclamation-triangle-fill me-2 text-danger"></i>Vulnerabilidades Críticas</span>
        <a href="{{ url_for('vulns.index') }}?severity=Critical" class="btn btn-xs btn-outline-accent">Ver todas</a>
      </div>
      <div class="card-dark-body p-0">
        {% if recent_vulns %}
        <div class="table-responsive">
          <table class="table table-dark-custom mb-0">
            <thead>
              <tr>
                <th>Título</th>
                <th>Sev.</th>
                <th>CVSS</th>
              </tr>
            </thead>
            <tbody>
              {% for v in recent_vulns %}
              <tr>
                <td>
                  <a href="{{ url_for('reports.view', report_id=v.report_id) }}" class="text-white small hover-accent">
                    {{ v.title|truncate(35) }}
                  </a>
                </td>
                <td><span class="badge-sev badge-{{ v.severity|lower }}">{{ v.severity }}</span></td>
                <td class="text-muted small">{{ '%.1f'|format(v.cvss_score) if v.cvss_score else '—' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="empty-state py-4">
            <i class="bi bi-shield-check"></i>
            <p>Nenhuma vuln. aberta</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const sevLabels = {{ sev_labels | tojson }};
const sevCounts = {{ sev_counts | tojson }};
const statusLabels = {{ status_labels | tojson }};
const statusCounts = {{ status_counts | tojson }};

const SEV_COLORS = {
  'Critical': '#f85149', 'High': '#db6d28',
  'Medium': '#d29922', 'Low': '#58a6ff', 'Informational': '#8b949e'
};
const STATUS_COLORS = {
  'Draft': '#8b949e', 'In Review': '#d29922', 'Final': '#3fb950'
};

if (sevLabels.length > 0) {
  new Chart(document.getElementById('sevChart'), {
    type: 'doughnut',
    data: {
      labels: sevLabels,
      datasets: [{
        data: sevCounts,
        backgroundColor: sevLabels.map(l => SEV_COLORS[l] || '#8b949e'),
        borderColor: '#161b22',
        borderWidth: 3,
        hoverOffset: 6,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right', labels: { color: '#c9d1d9', padding: 12, font: { size: 12 } } },
        tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed}` } }
      },
      cutout: '62%',
    }
  });
}

if (statusLabels.length > 0) {
  new Chart(document.getElementById('statusChart'), {
    type: 'bar',
    data: {
      labels: statusLabels,
      datasets: [{
        label: 'Relatórios',
        data: statusCounts,
        backgroundColor: statusLabels.map(l => STATUS_COLORS[l] || '#58a6ff'),
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e' } },
        y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', stepSize: 1 } }
      }
    }
  });
}
</script>
{% endblock %}
