{% extends 'base.html' %}
{% block title %}CWEs{% endblock %}
{% block page_title %}Catálogo de CWEs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <form method="GET" action="{{ url_for('cwes.index') }}" class="d-flex gap-2">
    <input type="text" name="q" value="{{ search }}" class="form-control form-control-sm"
           placeholder="Pesquisar CWE..." style="width:240px">
    <button type="submit" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-search"></i>
    </button>
    {% if search %}
      <a href="{{ url_for('cwes.index') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-x"></i>
      </a>
    {% endif %}
  </form>
  <a href="{{ url_for('cwes.create') }}" class="btn btn-accent">
    <i class="bi bi-plus-lg me-1"></i>Nova CWE
  </a>
</div>

{% if cwes %}
<div class="card-dark">
  <div class="card-dark-body p-0">
    <div class="table-responsive">
      <table class="table table-dark-custom mb-0">
        <thead>
          <tr>
            <th style="width:120px">CWE ID</th>
            <th>Nome</th>
            <th style="width:180px">Descrição</th>
            <th style="width:100px;text-align:center">Vulns.</th>
            <th style="width:90px"></th>
          </tr>
        </thead>
        <tbody>
          {% for cwe in cwes %}
          <tr>
            <td>
              <span class="cve-badge" style="font-size:13px;font-family:monospace">{{ cwe.cwe_id }}</span>
            </td>
            <td class="fw-medium">{{ cwe.name }}</td>
            <td class="text-muted small">
              {% if cwe.description %}
                {{ cwe.description|truncate(80) }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td style="text-align:center">
              {% set cnt = counts.get(cwe.id, 0) %}
              {% if cnt > 0 %}
                <a href="{{ url_for('vulns.index') }}?cwe={{ cwe.id }}" class="text-accent fw-bold">{{ cnt }}</a>
              {% else %}
                <span class="text-muted">0</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex gap-1 justify-content-end">
                <a href="{{ url_for('cwes.edit', cwe_pk=cwe.id) }}" class="btn btn-xs btn-outline-secondary" title="Editar">
                  <i class="bi bi-pencil"></i>
                </a>
                <form method="POST" action="{{ url_for('cwes.delete', cwe_pk=cwe.id) }}" class="d-inline"
                      onsubmit="return confirm('Excluir {{ cwe.cwe_id }}?')">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-xs btn-outline-danger"
                          {% if counts.get(cwe.id, 0) > 0 %}disabled title="Possui vulnerabilidades associadas"{% endif %}>
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<div class="mt-2 text-muted small">{{ cwes|length }} CWE(s) cadastrada(s)</div>
{% else %}
<div class="empty-state-page">
  <div class="empty-icon"><i class="bi bi-diagram-2"></i></div>
  <h4>Nenhuma CWE cadastrada</h4>
  <p class="text-muted">Cadastre as CWEs utilizadas nos seus testes para vincular às vulnerabilidades.</p>
  <a href="{{ url_for('cwes.create') }}" class="btn btn-accent mt-2">
    <i class="bi bi-plus-lg me-1"></i>Nova CWE
  </a>
</div>
{% endif %}
{% endblock %}
