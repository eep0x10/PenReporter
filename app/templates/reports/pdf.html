{%- set year = report.start_date.year if report.start_date else report.created_at.year -%}
{%- set doc_id -%}TDI-{{ year }}-{{ '%03d'|format(report.id) }}{%- endset -%}
{%- set sev_pt = {'Critical': 'Crítica', 'High': 'Alta', 'Medium': 'Média', 'Low': 'Baixa', 'Informational': 'Informativa'} -%}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<style>

/* ── Page Setup ─────────────────────────────────────────────── */
@page {
  size: A4;
  margin: 2cm 1.9cm 2.3cm 1.9cm;

  @top-left  { content: ''; }
  @top-right {
    content: 'CONFIDENCIAL';
    font-size: 8pt;
    font-family: Arial, sans-serif;
    font-weight: bold;
    letter-spacing: 1.5px;
    color: #444444;
    border: 1pt solid #444444;
    padding: 2pt 6pt;
    margin-top: 4pt;
  }
  @bottom-left {
    content: '{{ doc_id }}';
    font-size: 8pt;
    font-family: Arial, sans-serif;
    color: #666666;
  }
  @bottom-center { content: none; }
  @bottom-right {
    content: 'Página ' counter(page) ' / ' counter(pages);
    font-size: 8pt;
    font-family: Arial, sans-serif;
    color: #666666;
  }
}

@page cover {
  margin: 0;
  @top-left   { content: none; }
  @top-right  { content: none; }
  @bottom-left  { content: none; }
  @bottom-center { content: none; }
  @bottom-right { content: none; }
}

/* ── Base ───────────────────────────────────────────────────── */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: Arial, Helvetica, sans-serif;
  font-size: 11pt;
  color: #000000;
  background: #ffffff;
  line-height: 1.5;
}

p {
  margin-bottom: 9pt;
  text-align: justify;
  line-height: 1.6;
}

p.pre { white-space: pre-wrap; text-align: left; }

ul, ol { margin: 6pt 0 9pt 20pt; }
li { margin-bottom: 3pt; }

/* ── Section Headings ───────────────────────────────────────── */
.h1 {
  font-size: 16pt;
  font-weight: bold;
  color: #365F91;
  padding-bottom: 5pt;
  border-bottom: 1.5pt solid #95B3D7;
  margin-bottom: 14pt;
  page-break-after: avoid;
}

.h2 {
  font-size: 12pt;
  font-weight: bold;
  color: #365F91;
  margin: 14pt 0 7pt;
  page-break-after: avoid;
}

.section { page-break-before: always; }

/* ── Cover ──────────────────────────────────────────────────── */
.cover {
  page: cover;
  width: 21cm;
  height: 29.7cm;
  background: #ffffff;
  display: flex;
  flex-direction: column;
}

.cover-topbar {
  padding: 0.9cm 1.9cm 0;
  display: flex;
  justify-content: flex-end;
  align-items: center;
}

.cover-confidential {
  font-size: 9pt;
  font-weight: bold;
  letter-spacing: 2px;
  color: #333333;
  border: 1pt solid #333333;
  padding: 3pt 9pt;
  text-transform: uppercase;
}

.cover-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 1.5cm 2.5cm;
  gap: 18pt;
}

.cover-main-title {
  font-size: 26pt;
  font-weight: bold;
  color: #000000;
  line-height: 1.2;
}

.cover-scope {
  font-size: 20pt;
  font-weight: bold;
  color: #1F497D;
  line-height: 1.3;
}

.cover-date {
  font-size: 14pt;
  font-weight: bold;
  color: #333333;
}

.cover-footer {
  background: #1F497D;
  padding: 0.7cm 1.9cm;
  text-align: center;
  color: #ffffff;
}

.cover-footer-line1 { font-size: 16pt; font-weight: normal; margin-bottom: 3pt; }
.cover-footer-line2 { font-size: 14pt; font-weight: normal; }

/* ── Summary Table (TABLE 1) ─────────────────────────────────── */
.summary-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 9.5pt;
  margin: 10pt 0 14pt;
}

.summary-table th {
  background: #000000;
  color: #ffffff;
  padding: 6pt 9pt;
  text-align: left;
  font-weight: bold;
  border: 1pt solid #000000;
}

.summary-table td {
  padding: 5pt 9pt;
  border: 1pt solid #BFBFBF;
  vertical-align: middle;
}

.summary-table tr:nth-child(even) td { background: #F5F5F5; }

/* Severity cells */
.sc-critical     { background:#7030A0; color:#ffffff; font-weight:bold; text-align:center; }
.sc-high         { background:#FF0000; color:#ffffff; font-weight:bold; text-align:center; }
.sc-medium       { background:#FFFF00; color:#000000; font-weight:bold; text-align:center; }
.sc-low          { background:#00B0F0; color:#000000; font-weight:bold; text-align:center; }
.sc-informational{ background:#BFBFBF; color:#000000; font-weight:bold; text-align:center; }

/* ── CVSS Legend (TABLE 2) ───────────────────────────────────── */
.cvss-legend {
  border-collapse: collapse;
  font-size: 9pt;
  margin: 4pt 0 14pt;
}

.cvss-legend td {
  padding: 4pt 14pt;
  border: 1pt solid #888888;
  font-weight: bold;
  text-align: center;
  min-width: 90pt;
}

/* ── Properties & History Tables ─────────────────────────────── */
.props-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 10pt;
  margin-top: 10pt;
}

.props-table td {
  padding: 6pt 10pt;
  border: 1pt solid #BFBFBF;
  vertical-align: top;
}

.props-table td.label {
  background: #1F497D;
  color: #ffffff;
  font-weight: bold;
  width: 32%;
  white-space: nowrap;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 10pt;
  margin-top: 10pt;
}

.history-table th {
  background: #1F497D;
  color: #ffffff;
  padding: 6pt 10pt;
  border: 1pt solid #1F497D;
  font-weight: bold;
  text-align: left;
}

.history-table td {
  padding: 5pt 10pt;
  border: 1pt solid #BFBFBF;
  vertical-align: middle;
}

/* ── Vulnerability Card (TABLE 3) ────────────────────────────── */
.vuln-card {
  width: 100%;
  border-collapse: collapse;
  font-size: 10pt;
  margin: 8pt 0 24pt;
  border: 1pt solid #1F497D;
}

.vuln-card td { vertical-align: top; padding: 5pt 9pt; }

/* Dark navy header rows */
.vh {
  background: #1F497D;
  color: #ffffff;
  font-weight: bold;
  font-size: 9.5pt;
  letter-spacing: 0.3px;
  border: 1pt solid #1F497D !important;
  padding: 5pt 9pt;
}

/* Light-blue sub-header */
.vs {
  background: #95B3D7;
  color: #000000;
  font-weight: bold;
  font-size: 9pt;
  border: 1pt solid #7090B0 !important;
  padding: 4pt 9pt;
}

/* White body cells */
.vb {
  background: #ffffff;
  border: 1pt solid #BFBFBF;
  white-space: pre-wrap;
  line-height: 1.6;
}

/* Code/PoC body */
.vc {
  background: #F4F4F4;
  border: 1pt solid #BFBFBF;
  font-family: 'Courier New', Courier, monospace;
  font-size: 8.5pt;
  white-space: pre-wrap;
  word-break: break-all;
  line-height: 1.4;
}

/* Severity value cell variants */
.vs-critical { background:#7030A0; color:#ffffff; font-weight:bold; font-size:11pt; text-align:center; border:1pt solid #5A2080 !important; }
.vs-high     { background:#FF0000; color:#ffffff; font-weight:bold; font-size:11pt; text-align:center; border:1pt solid #CC0000 !important; }
.vs-medium   { background:#FFFF00; color:#000000; font-weight:bold; font-size:11pt; text-align:center; border:1pt solid #CCCC00 !important; }
.vs-low      { background:#00B0F0; color:#000000; font-weight:bold; font-size:11pt; text-align:center; border:1pt solid #0090C0 !important; }
.vs-informational { background:#BFBFBF; color:#000000; font-weight:bold; font-size:11pt; text-align:center; border:1pt solid #999999 !important; }

</style>
</head>
<body>

{# ═══════════════════════════════ CAPA ════════════════════════════════ #}
<div class="cover">
  <div class="cover-topbar">
    <div class="cover-confidential">CONFIDENCIAL</div>
  </div>

  <div class="cover-body">
    <div class="cover-main-title">RELATÓRIO DE TESTE DE INTRUSÃO</div>
    <div class="cover-scope">{{ report.product.name }}</div>
    <div class="cover-date">
      {%- if report.start_date -%}
        {{ report.start_date.strftime('%d/%m/%Y') }}
        {%- if report.end_date %} – {{ report.end_date.strftime('%d/%m/%Y') }}{% endif %}
      {%- else -%}
        {{ report.created_at.strftime('%d/%m/%Y') }}
      {%- endif -%}
    </div>
  </div>

  <div class="cover-footer">
    <div class="cover-footer-line1">DITI - CIBERSEGURANÇA</div>
    <div class="cover-footer-line2">SEGURANÇA OFENSIVA</div>
  </div>
</div>


{# ═══════════════════ 1. SUMÁRIO EXECUTIVO ═══════════════════════════ #}
<div class="section">
  <div class="h1">1. SUMÁRIO EXECUTIVO</div>

  <div class="h2">1.1 Contexto e Objetivos do Teste</div>
  {% if report.executive_summary %}
    <p class="pre">{{ report.executive_summary }}</p>
  {% else %}
    <p>Descrever de forma clara e sucinta o contexto do teste e os objetivos almejados.</p>
  {% endif %}

  <div class="h2">1.2 Resultados Alcançados</div>
  <p>As seguintes vulnerabilidades foram encontradas:</p>

  <table class="summary-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Título</th>
        <th>Severidade</th>
        <th>CVSS</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody>
      {% for vuln in vulns %}
      <tr>
        <td style="white-space:nowrap;font-family:'Courier New',monospace;font-size:8.5pt">
          {{ doc_id }}-{{ '%03d'|format(loop.index) }}
        </td>
        <td>{{ vuln.title }}</td>
        <td class="sc-{{ vuln.severity|lower }}">
          {{ sev_pt.get(vuln.severity, vuln.severity) }}
        </td>
        <td style="text-align:center;font-size:8.5pt">
          {{ vuln.cvss_vector if vuln.cvss_vector else '—' }}
        </td>
        <td style="text-align:center;font-weight:bold">
          {{ '%.1f'|format(vuln.cvss_score) if vuln.cvss_score else '—' }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <table class="cvss-legend">
    <tr>
      <td style="background:#0D0D0D;color:#FFFFFF;border-color:#0D0D0D">Severidade</td>
      <td style="background:#0D0D0D;color:#FFFFFF;border-color:#0D0D0D">Score</td>
    </tr>
    <tr>
      <td style="background:#BFBFBF;color:#000">Informativa</td>
      <td style="background:#BFBFBF;color:#000">0</td>
    </tr>
    <tr>
      <td style="background:#00B0F0;color:#000">Baixa</td>
      <td style="background:#00B0F0;color:#000">0.1 – 3.9</td>
    </tr>
    <tr>
      <td style="background:#FFFF00;color:#000">Média</td>
      <td style="background:#FFFF00;color:#000">4.0 – 6.9</td>
    </tr>
    <tr>
      <td style="background:#FF0000;color:#fff">Alta</td>
      <td style="background:#FF0000;color:#fff">7.0 – 8.9</td>
    </tr>
    <tr>
      <td style="background:#7030A0;color:#fff">Crítica</td>
      <td style="background:#7030A0;color:#fff">9.0 – 10.0</td>
    </tr>
  </table>

  <div class="h2">1.3 Principais Impactos</div>
  {% if counts.Critical > 0 or counts.High > 0 %}
    <p>As principais vulnerabilidades identificadas com maior potencial de impacto são:</p>
    <ul>
      {% for vuln in vulns %}
        {% if vuln.severity == 'Critical' or vuln.severity == 'High' %}
        <li>
          <strong>{{ sev_pt.get(vuln.severity, vuln.severity) }} — {{ vuln.title }}</strong>
          {% if vuln.impact %}
            : {{ vuln.impact[:250] }}{% if vuln.impact|length > 250 %}…{% endif %}
          {% endif %}
        </li>
        {% endif %}
      {% endfor %}
    </ul>
  {% else %}
    <p>Nenhuma vulnerabilidade de alta criticidade foi identificada.</p>
  {% endif %}

  <div class="h2">1.4 Recomendações</div>
  <p>Recomenda-se a avaliação e correção das vulnerabilidades que foram reportadas na seção <strong>VULNERABILIDADES ENCONTRADAS</strong>.</p>
</div>


{# ═══════════════ 2. DETALHAMENTO DO ESCOPO ══════════════════════════ #}
<div class="section">
  <div class="h1">2. DETALHAMENTO DO ESCOPO</div>

  <div class="h2">2.1 Escopo</div>
  {% if report.scope %}
    <p class="pre">{{ report.scope }}</p>
  {% else %}
    <p>—</p>
  {% endif %}

  <div class="h2">2.2 Modalidade de Teste</div>
  <p>{{ report.report_type }}</p>

  <div class="h2">2.3 Origem</div>
  <p>
    Teste conduzido por <strong>{{ report.author.full_name }}</strong>
    {%- if report.reviewer %}, com revisão de <strong>{{ report.reviewer.full_name }}</strong>{% endif %}.
  </p>

  <div class="h2">2.4 Período</div>
  <p>
    {% if report.start_date %}
      {{ report.start_date.strftime('%d/%m/%Y') }}
      {%- if report.end_date %} a {{ report.end_date.strftime('%d/%m/%Y') }}{% endif %}
    {% else %}
      Não informado.
    {% endif %}
  </p>

  <div class="h2">2.5 Limitações</div>
  <p>Limitações do escopo e testes não permitidos durante a avaliação:</p>
  <ul>
    <li>Ataques de Engenharia Social</li>
    <li>Ataques de Negação de Serviço (DoS/DDoS)</li>
  </ul>
</div>


{# ═══════════════════ 3. METODOLOGIA ════════════════════════════════ #}
<div class="section">
  <div class="h1">3. METODOLOGIA</div>

  {% if report.methodology %}
    <p class="pre">{{ report.methodology }}</p>
  {% else %}
    <p>A necessidade, propósito e execução da atividade está fundamentada em sistemas normativos, órgãos reguladores e boas práticas de mercado, mais especificamente:</p>
    <ul>
      <li>Política e Normas Corporativas de Segurança da Informação</li>
      <li>Resoluções do BACEN sobre Segurança Cibernética</li>
      <li>ISO/IEC 27001</li>
      <li>The Penetration Testing Execution Standard (PTES)</li>
      <li>MITRE (mitre.org)</li>
      <li>Open Web Application Security Project (OWASP)</li>
    </ul>
  {% endif %}

  <p>O cálculo da classificação de risco utilizada nesse documento tem como base o padrão
    <strong>CVSS</strong> (https://www.first.org/cvss/specification-document),
    e visa identificar as principais características das vulnerabilidades, atribuindo um
    <strong>score</strong> de 0 a 10, de acordo com sua severidade.</p>
</div>


{# ═══════════════ 4. NARRATIVA DO TESTE ══════════════════════════════ #}
{% if report.conclusion %}
<div class="section">
  <div class="h1">4. NARRATIVA DO TESTE</div>
  <p class="pre">{{ report.conclusion }}</p>
</div>
{% endif %}


{# ══════════════ 5. VULNERABILIDADES ENCONTRADAS ════════════════════ #}
<div class="section">
  <div class="h1">5. VULNERABILIDADES ENCONTRADAS</div>
  <p>A seguir serão listadas as vulnerabilidades encontradas durante o teste de intrusão realizado.</p>

  {% for vuln in vulns %}
  {%- set vuln_id = doc_id + '-' + '%03d'|format(loop.index) -%}

  <div class="h2">5.{{ loop.index }} {{ vuln.title }}</div>

  <table class="vuln-card">

    {# ── Severity row ── #}
    <tr>
      <td class="vh" style="width:22%;white-space:nowrap">SEVERIDADE</td>
      <td class="vs-{{ vuln.severity|lower }}" colspan="4">
        {{ sev_pt.get(vuln.severity, vuln.severity) }}
        {%- if vuln.cvss_score %} &nbsp;—&nbsp; CVSS {{ '%.1f'|format(vuln.cvss_score) }}{% endif %}
      </td>
    </tr>

    {# ── Affected assets header ── #}
    <tr><td class="vh" colspan="5">ATIVOS VULNERÁVEIS</td></tr>

    {# ── Asset sub-header ── #}
    <tr>
      <td class="vs" style="width:22%">ID</td>
      <td class="vs" style="width:38%" colspan="2">Hostname / URL / Componente</td>
      <td class="vs" style="width:20%">CVE / CWE</td>
      <td class="vs" style="width:20%">Score</td>
    </tr>

    {# ── Asset data ── #}
    <tr>
      <td style="font-family:'Courier New',monospace;font-size:8.5pt;white-space:nowrap;border:1pt solid #BFBFBF">
        {{ vuln_id }}
      </td>
      <td colspan="2" style="border:1pt solid #BFBFBF">
        {{ vuln.affected_component or 'N/A' }}
      </td>
      <td style="border:1pt solid #BFBFBF;font-size:9pt">
        {%- if vuln.cve_id %}{{ vuln.cve_id }}{% endif %}
        {%- if vuln.cwe %}
          {%- if vuln.cve_id %}<br>{% endif %}
          {{ vuln.cwe.cwe_id }}
        {%- endif %}
        {%- if not vuln.cve_id and not vuln.cwe %}—{% endif %}
      </td>
      <td style="border:1pt solid #BFBFBF;text-align:center;font-weight:bold">
        {{ '%.1f'|format(vuln.cvss_score) if vuln.cvss_score else '—' }}
      </td>
    </tr>

    {%- if vuln.cvss_vector %}
    <tr>
      <td class="vs">CVSS Vector</td>
      <td colspan="4" style="border:1pt solid #BFBFBF;font-family:'Courier New',monospace;font-size:8pt">
        {{ vuln.cvss_vector }}
      </td>
    </tr>
    {%- endif %}

    {# ── Description ── #}
    <tr><td class="vh" colspan="5">DESCRIÇÃO</td></tr>
    <tr><td class="vb" colspan="5">{{ vuln.description or '—' }}</td></tr>

    {# ── Impact ── #}
    <tr><td class="vh" colspan="5">IMPACTO</td></tr>
    <tr><td class="vb" colspan="5">{{ vuln.impact or '—' }}</td></tr>

    {# ── Recommendation ── #}
    <tr><td class="vh" colspan="5">RECOMENDAÇÃO</td></tr>
    <tr><td class="vb" colspan="5">{{ vuln.recommendation or '—' }}</td></tr>

    {%- if vuln.references %}
    {# ── References ── #}
    <tr><td class="vh" colspan="5">REFERÊNCIAS</td></tr>
    <tr><td class="vb" colspan="5" style="font-size:9.5pt">{{ vuln.references }}</td></tr>
    {%- endif %}

    {%- if vuln.evidences %}
    {# ── Evidence images ── #}
    <tr><td class="vh" colspan="5">EVIDÊNCIAS</td></tr>
    {% for ev in vuln.evidences %}
    <tr>
      <td class="vb" colspan="5" style="padding:10pt 9pt">
        <div style="font-weight:bold;font-size:9.5pt;margin-bottom:6pt">
          Imagem {{ loop.index }}{% if ev.description %} — {{ ev.description }}{% endif %}
        </div>
        {%- set b64 = ev.filename | file_to_b64 -%}
        {%- if b64 %}
        <div style="text-align:center;margin-bottom:8pt">
          <img src="{{ b64 }}"
               style="max-width:100%;max-height:420pt;display:block;margin:0 auto;border:1pt solid #BFBFBF">
        </div>
        {%- endif %}
        {%- if ev.body_text %}
        <div style="font-size:9.5pt;color:#444444;white-space:pre-wrap;margin-top:6pt">{{ ev.body_text }}</div>
        {%- endif %}
      </td>
    </tr>
    {% endfor %}
    {%- endif %}

  </table>
  {% endfor %}
</div>


{# ═══════════════ 6. PROPRIEDADES DO DOCUMENTO ══════════════════════ #}
<div class="section">
  <div class="h1">6. PROPRIEDADES DO DOCUMENTO</div>

  <table class="props-table">
    <tr>
      <td colspan="2"
          style="background:#1F497D;color:#ffffff;font-weight:bold;text-align:center;font-size:11pt;padding:7pt 10pt;border:1pt solid #1F497D">
        {{ doc_id }}
      </td>
    </tr>
    <tr>
      <td class="label">TÍTULO</td>
      <td>{{ report.title }}</td>
    </tr>
    <tr>
      <td class="label">ALVO / PRODUTO</td>
      <td>
        {{ report.product.name }}
        {%- if report.product.owner %} — {{ report.product.owner }}{% endif %}
        {%- if report.product.target_url %}<br><span style="font-size:9pt;color:#555">{{ report.product.target_url }}</span>{% endif %}
      </td>
    </tr>
    <tr>
      <td class="label">TIPO DE TESTE</td>
      <td>{{ report.report_type }}</td>
    </tr>
    <tr>
      <td class="label">VERSÃO</td>
      <td>{{ report.version }}</td>
    </tr>
    <tr>
      <td class="label">AUTOR</td>
      <td>{{ report.author.full_name }}</td>
    </tr>
    {% if report.reviewer %}
    <tr>
      <td class="label">REVISOR</td>
      <td>{{ report.reviewer.full_name }}</td>
    </tr>
    {% endif %}
    <tr>
      <td class="label">STATUS</td>
      <td>{{ report.status }}</td>
    </tr>
    <tr>
      <td class="label">CLASSIFICAÇÃO</td>
      <td>Confidencial</td>
    </tr>
  </table>
</div>


{# ═══════════════ 7. HISTÓRICO DO DOCUMENTO ════════════════════════ #}
<div>
  <div class="h1" style="margin-top:20pt">7. HISTÓRICO DO DOCUMENTO</div>

  <table class="history-table">
    <thead>
      <tr>
        <th>VERSÃO</th>
        <th>DATA</th>
        <th>AUTOR</th>
        <th>DESCRIÇÃO</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ report.version }}</td>
        <td>{{ report.updated_at.strftime('%d/%m/%Y') }}</td>
        <td>{{ report.author.full_name }}</td>
        <td>
          {%- if report.status == 'Final' %}Versão Final
          {%- elif report.status == 'In Review' %}Em Revisão
          {%- else %}Rascunho / Em elaboração{% endif -%}
        </td>
      </tr>
    </tbody>
  </table>
</div>

</body>
</html>
